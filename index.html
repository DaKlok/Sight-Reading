<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Infinite Flowkey Sight Reading v3.2.0</title>

<script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>

<style>
:root {
    --primary: #6750A4;
    --surface: #F7F2FA;
    --background: #FEF7FF;
    --outline: #79747E;
    --target-note: #00A96B;
    --default-note: #6750A4;
    --correct-flash: #EADDFF;
    --wrong-flash: #F2B8B5;
    --text-color: #1C1B1F;
}

body {
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--background);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    color: var(--text-color);
}

.container {
    background-color: var(--surface);
    padding: 40px;
    border-radius: 28px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    text-align: center;
    width: 90%;
    max-width: 800px;
    border: 1px solid #EADDFF;
}

.header-content {
    display: flex;
    justify-content: center;
    gap: 10px;
}

h1 {
    color: var(--primary);
    font-weight: 400;
    margin: 0;
}

.version-tag {
    color: var(--outline);
}

.status-chip {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: bold;
    margin: 20px 0;
    background: #E6E1E5;
}

.status-ready {
    background: #D0BCFF;
    color: #381E72;
}

.btn-group {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-bottom: 30px;
}

button {
    border: 1px solid var(--outline);
    background: transparent;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
}

button.active {
    background-color: var(--primary);
    color: white;
}

#notation-window {
    width: 600px;
    height: 150px;
    margin: 20px auto;
    border-radius: 16px;
    border: 2px solid var(--primary);
    display: flex;
    justify-content: center;
    align-items: center;
}

.feedback {
    font-size: 1.2rem;
    font-weight: bold;
    height: 1.5em;
    color: var(--primary);
}
</style>
</head>

<body>

<div class="container" id="app-card">
    <div class="header-content">
        <h1>MelodyFlow</h1>
        <span class="version-tag">v3.2.0</span>
    </div>

    <div id="status" class="status-chip">Waiting for MIDI...</div>

    <div class="btn-group">
        <button class="active" onclick="setDiff('Beginner')">Beginner</button>
        <button onclick="setDiff('Intermediate')">Intermediate</button>
        <button onclick="setDiff('Advanced')">Advanced</button>
    </div>

    <div id="notation-window">
        <div id="notation"></div>
    </div>

    <div class="feedback" id="feedback-text">Play the highlighted note</div>

    <div style="margin-top:10px;font-size:0.8rem;color:#666">
        Notes Completed: <span id="notes-completed">0</span>
    </div>
</div>

<script>
const VF = Vex.Flow;

let difficulty = 'Beginner';
let sequence = [];
let notesCompleted = 0;

const notesPerMeasure = 4;

const levels = {
    Beginner: ['c/4','d/4','e/4','f/4','g/4'],
    Intermediate: ['c/4','d/4','e/4','f/4','g/4','a/4','b/4','c/5'],
    Advanced: ['g/3','a/3','b/3','c/4','d/4','e/4','f/4','g/4','a/4','b/4','c/5','d/5','e/5']
};

function generateNote() {
    const pool = levels[difficulty];
    return pool[Math.floor(Math.random() * pool.length)];
}

function startExercise() {
    notesCompleted = 0;
    document.getElementById('notes-completed').innerText = 0;

    sequence = [];
    for (let i = 0; i < notesPerMeasure; i++) {
        sequence.push(generateNote());
    }

    drawMeasure();
}

function setDiff(diff) {
    difficulty = diff;
    document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    startExercise();
}

function drawMeasure() {
    const container = document.getElementById('notation');
    container.innerHTML = '';

    const renderer = new VF.Renderer(container, VF.Renderer.Backends.SVG);
    renderer.resize(600, 150);
    const context = renderer.getContext();

    const stave = new VF.Stave(10, 20, 580);
    stave.addClef("treble").addTimeSignature("4/4");
    stave.setContext(context).draw();

    const notes = sequence.map((key, i) => {
        const note = new VF.StaveNote({ keys:[key], duration:'q' });
        note.setAttribute('data-index', i);
        if (key.includes('#')) note.addModifier(new VF.Accidental('#'));
        return note;
    });

    const voice = new VF.Voice({ num_beats: 4, beat_value: 4 });
    voice.addTickables(notes);
    new VF.Formatter().joinVoices([voice]).format([voice], 520);
    voice.draw(context, stave);

    highlightTarget();
}

function highlightTarget() {
    const target = document.querySelector('[data-index="0"]');
    if (!target) return;
    target.querySelectorAll('.vf-notehead path').forEach(p => {
        p.style.fill = getComputedStyle(document.documentElement)
            .getPropertyValue('--target-note');
    });
}

function handleCorrectNote() {
    sequence.shift();
    sequence.push(generateNote());
    notesCompleted++;
    document.getElementById('notes-completed').innerText = notesCompleted;
    drawMeasure();
}

function midiToVex(midi) {
    const names = ['c','c#','d','d#','e','f','f#','g','g#','a','a#','b'];
    return `${names[midi % 12]}/${Math.floor(midi / 12) - 1}`;
}

/* MIDI */
navigator.requestMIDIAccess().then(midi => {
    document.getElementById('status').innerText = "MIDI Connected";
    document.getElementById('status').classList.add('status-ready');
    for (let input of midi.inputs.values()) {
        input.onmidimessage = e => {
            if (e.data[0] === 144 && e.data[2] > 0) {
                if (midiToVex(e.data[1]) === sequence[0]) {
                    handleCorrectNote();
                }
            }
        };
    }
});

startExercise();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MelodyFlow v6.0</title>
<script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>

<style>
:root {
  --primary:#6750A4;
  --surface:#F7F2FA;
  --bg:#FEF7FF;
  --outline:#79747E;
  --target:#00A96B;
  --wrong:#F2B8B5;
}

body {
  background:var(--bg);
  font-family:Segoe UI, Roboto, sans-serif;
  margin:0;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}

.container {
  background:var(--surface);
  padding:32px;
  border-radius:24px;
  width:95%;
  max-width:980px;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
  text-align:center;
}

h1 { color:var(--primary); margin-bottom:12px; }

.controls, .toggles {
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:12px;
}

button {
  padding:8px 16px;
  border-radius:18px;
  border:1px solid var(--outline);
  background:transparent;
  cursor:pointer;
}

button.active {
  background:var(--primary);
  color:white;
}

.toggle {
  font-size:.85rem;
  display:flex;
  align-items:center;
  gap:6px;
}

.toggle input { accent-color:var(--primary); }

#notation-wrap {
  width:820px;
  height:190px;
  margin:18px auto;
  border:2px solid var(--primary);
  border-radius:14px;
  overflow:hidden;
}

#notation {
  opacity:1;
  transition:opacity .15s ease;
}

.fade {
  opacity:0;
}

.wrong-flash {
  outline:3px solid var(--wrong);
  outline-offset:-3px;
}

.stats {
  display:flex;
  justify-content:center;
  gap:20px;
  font-size:.85rem;
  margin-top:8px;
}
</style>
</head>

<body>
<div class="container" id="card">
<h1>MelodyFlow</h1>

<div class="controls">
  <button class="active" onclick="setDifficulty('Beginner')">Beginner</button>
  <button onclick="setDifficulty('Intermediate')">Intermediate</button>
  <button onclick="setDifficulty('Advanced')">Advanced</button>
</div>

<div class="toggles">
  <label class="toggle">Bass (LH)
    <input type="checkbox" id="clefToggle">
  </label>
  <label class="toggle">Chord Mode
    <input type="checkbox" id="chordToggle">
  </label>
</div>

<div id="notation-wrap">
  <div id="notation"></div>
</div>

<div class="stats">
  <div>Score: <span id="score">0</span></div>
  <div>Accuracy: <span id="acc">100%</span></div>
  <div>Streak: <span id="streak">0</span></div>
</div>

<button onclick="exportStats()" style="margin-top:10px">Export Stats</button>
</div>

<script>
const VF = Vex.Flow;
const NOTES_VISIBLE = 8;

let difficulty = 'Beginner';
let clef = 'treble';
let chordMode = false;

let sequence = [];
let pendingChord = new Set();
let lastTime = performance.now();

let stats = {
  total:0,
  correct:0,
  streak:0,
  best:0,
  score:0,
  times:[]
};

const keyMap = {
  Beginner: ['C'],
  Intermediate: ['C','G','F'],
  Advanced: ['C','G','D','F','Bb']
};

const ranges = {
  treble: {
    Beginner:['c/4','d/4','e/4','f/4','g/4'],
    Intermediate:['a/3','b/3','c/4','d/4','e/4','f/4','g/4','a/4'],
    Advanced:['f/3','g/3','a/3','b/3','c/4','d/4','e/4','f/4','g/4','a/4','b/4','c/5']
  },
  bass: {
    Beginner:['c/3','d/3','e/3','f/3','g/3'],
    Intermediate:['b/2','c/3','d/3','e/3','f/3','g/3','a/3'],
    Advanced:['g/2','a/2','b/2','c/3','d/3','e/3','f/3','g/3']
  }
};

function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function generateItem() {
  const root = rand(ranges[clef][difficulty]);
  if (!chordMode) return [root];

  const scale = ['c','d','e','f','g','a','b'];
  const [n,o] = root.split('/');
  const i = scale.indexOf(n[0]);
  return [
    root,
    `${scale[(i+2)%7]}/${o}`,
    `${scale[(i+4)%7]}/${o}`
  ];
}

function start() {
  sequence=[];
  for(let i=0;i<NOTES_VISIBLE;i++) sequence.push(generateItem());
  draw();
}

function draw() {
  const el=document.getElementById('notation');
  el.classList.add('fade');

  setTimeout(()=>{
    el.innerHTML='';
    el.classList.remove('fade');

    const renderer=new VF.Renderer(el,VF.Renderer.Backends.SVG);
    renderer.resize(900,190);
    const ctx=renderer.getContext();

    const key=rand(keyMap[difficulty]);
    const stave=new VF.Stave(10,40,860);
    stave.addClef(clef).addKeySignature(key).addTimeSignature("4/4");
    stave.setContext(ctx).draw();

    const notes=sequence.map((keys,i)=>{
      const n=new VF.StaveNote({keys,duration:'q',clef});
      n.setAttribute('data-i',i);
      return n;
    });

    const voice=new VF.Voice({num_beats:NOTES_VISIBLE,beat_value:4});
    voice.addTickables(notes);
    new VF.Formatter().joinVoices([voice]).format([voice],820);
    voice.draw(ctx,stave);

    highlight();
  },120);
}

function highlight() {
  document.querySelectorAll('.vf-notehead path').forEach(p=>p.style.fill='#6750A4');
  const t=document.querySelector('[data-i="0"]');
  if(!t) return;
  t.querySelectorAll('.vf-notehead path').forEach(p=>p.style.fill='#00A96B');
}

function noteOn(note) {
  stats.total++;

  if (sequence[0].includes(note)) {
    pendingChord.add(note);
    if (pendingChord.size === sequence[0].length) {
      correct();
    }
  } else {
    wrong();
  }
}

function correct() {
  pendingChord.clear();
  stats.correct++;
  stats.streak++;
  stats.best=Math.max(stats.best,stats.streak);

  const now=performance.now();
  const dt=now-lastTime;
  lastTime=now;
  stats.times.push(dt);
  stats.score+=Math.max(0,Math.floor(1000-dt));

  sequence.shift();
  sequence.push(generateItem());
  updateStats();
  draw();
}

function wrong() {
  stats.streak=0;
  const card=document.getElementById('card');
  card.classList.add('wrong-flash');
  setTimeout(()=>card.classList.remove('wrong-flash'),150);
  updateStats();
}

function updateStats() {
  document.getElementById('score').innerText=stats.score;
  document.getElementById('streak').innerText=stats.streak;
  document.getElementById('acc').innerText=
    Math.round((stats.correct/stats.total)*100)+'%';
}

function midiToVex(m){
  const n=['c','c#','d','d#','e','f','f#','g','g#','a','a#','b'];
  return `${n[m%12]}/${Math.floor(m/12)-1}`;
}

navigator.requestMIDIAccess().then(m=>{
  for(let input of m.inputs.values()){
    input.onmidimessage=e=>{
      if(e.data[0]===144&&e.data[2]>0){
        noteOn(midiToVex(e.data[1]));
      }
    };
  }
});

document.getElementById('clefToggle').onchange=e=>{
  clef=e.target.checked?'bass':'treble';
  start();
};

document.getElementById('chordToggle').onchange=e=>{
  chordMode=e.target.checked;
  start();
};

function setDifficulty(d){
  difficulty=d;
  document.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  start();
}

function exportStats() {
  const blob=new Blob([JSON.stringify(stats,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='melodyflow_stats.json';
  a.click();
}

start();
</script>
</body>
</html>

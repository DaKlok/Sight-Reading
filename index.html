<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MelodyFlow v5.0</title>

<script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>

<style>
:root {
    --primary:#6750A4;
    --surface:#F7F2FA;
    --background:#FEF7FF;
    --target:#00A96B;
    --default:#6750A4;
    --wrong:#B3261E;
}

body {
    margin:0;
    height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background:var(--background);
    font-family:Segoe UI, Roboto, sans-serif;
}

.container {
    background:var(--surface);
    padding:32px;
    border-radius:28px;
    width:900px;
    box-shadow:0 8px 24px rgba(0,0,0,.15);
    text-align:center;
}

.toggle-group {
    display:flex;
    justify-content:center;
    gap:20px;
    margin-bottom:12px;
}

.toggle {
    font-size:.85rem;
}

#notation-window {
    border:2px solid var(--primary);
    border-radius:16px;
    margin:16px auto;
    width:720px;
    height:180px;
    overflow:hidden;
}

.shake {
    animation:shake .3s;
}

@keyframes shake {
    0% { transform:translateX(0); }
    25% { transform:translateX(-6px); }
    50% { transform:translateX(6px); }
    75% { transform:translateX(-4px); }
    100% { transform:translateX(0); }
}

.slide {
    animation:slide .35s ease-out forwards;
}

@keyframes slide {
    from { transform:translateX(0); }
    to { transform:translateX(-90px); }
}

.keyboard {
    display:flex;
    justify-content:center;
    margin-top:14px;
}

.key {
    width:44px;
    height:140px;
    border:1px solid #444;
    margin:1px;
    background:white;
    border-radius:6px;
    cursor:pointer;
}

.black {
    background:black;
    width:28px;
    height:90px;
    margin-left:-14px;
    margin-right:-14px;
    z-index:2;
}
</style>
</head>

<body>
<div class="container">
<h1>MelodyFlow</h1>

<div class="toggle-group">
<label class="toggle">Bass <input type="checkbox" id="clef"></label>
<label class="toggle">Chord <input type="checkbox" id="chord"></label>
<label class="toggle">Adaptive <input type="checkbox" id="adaptive" checked></label>
<label class="toggle">Rhythm <input type="checkbox" id="rhythm"></label>
</div>

<div id="notation-window">
<div id="notation"></div>
</div>

<div>
Accuracy: <span id="acc">100%</span> |
Streak: <span id="streak">0</span>
</div>

<div class="keyboard" id="kbd"></div>
</div>

<script>
const VF = Vex.Flow;
let clef='treble', chord=false, adaptive=true, rhythm=false;
let correct=0, total=0, streak=0;
let difficulty='Beginner';

const keysigs=['C','G','D','F','Bb'];

const ranges={
Beginner:['c/4','d/4','e/4','f/4','g/4'],
Intermediate:['a/3','b/3','c/4','d/4','e/4','f/4','g/4','a/4'],
Advanced:['f/3','g/3','a/3','b/3','c/4','d/4','e/4','f/4','g/4','a/4','b/4','c/5']
};

let seq=[];

function rand(arr){return arr[Math.floor(Math.random()*arr.length)]}

function genNote(){
    let n=rand(ranges[difficulty]);
    return chord?[n]:[n];
}

function draw(){
    const el=document.getElementById('notation');
    el.innerHTML='';
    const r=new VF.Renderer(el,VF.Renderer.Backends.SVG);
    r.resize(720,180);
    const ctx=r.getContext();
    const stave=new VF.Stave(10,40,700);
    stave.addClef(clef).addKeySignature(rand(keysigs));
    stave.setContext(ctx).draw();

    const notes=seq.map((g,i)=>{
        let n=new VF.StaveNote({
            keys:g,
            duration: rhythm && Math.random()<.3?'8':'q',
            clef
        });
        n.setAttribute('data-i',i);
        return n;
    });

    const v=new VF.Voice({num_beats:8,beat_value:4});
    v.addTickables(notes);
    new VF.Formatter().joinVoices([v]).format([v],620);
    v.draw(ctx,stave);
    highlight();
}

function highlight(){
    document.querySelectorAll('.vf-notehead path')
        .forEach(p=>p.style.fill='var(--default)');
    const t=document.querySelector('[data-i="0"]');
    if(!t)return;
    t.querySelectorAll('.vf-notehead path')
        .forEach(p=>p.style.fill='var(--target)');
}

function correctNote(){
    correct++; total++; streak++;
    document.getElementById('streak').textContent=streak;
    animateSlide();
    setTimeout(()=>{
        seq.shift(); seq.push(genNote()); draw();
    },350);
    updateAcc();
}

function wrongNote(){
    total++; streak=0;
    document.getElementById('streak').textContent=0;
    document.querySelector('#notation-window').classList.add('shake');
    setTimeout(()=>document.querySelector('#notation-window').classList.remove('shake'),300);
    updateAcc();
}

function animateSlide(){
    document.querySelector('svg').classList.add('slide');
}

function updateAcc(){
    document.getElementById('acc').textContent=
        Math.round(correct/total*100)+'%';
}

function start(){
    seq=[];
    for(let i=0;i<8;i++) seq.push(genNote());
    draw();
}

function midiToVex(m){
    const n=['c','c#','d','d#','e','f','f#','g','g#','a','a#','b'];
    return `${n[m%12]}/${Math.floor(m/12)-1}`;
}

navigator.requestMIDIAccess().then(m=>{
    for(let i of m.inputs.values()){
        i.onmidimessage=e=>{
            if(e.data[0]===144&&e.data[2]>0){
                const p=midiToVex(e.data[1]);
                seq[0].includes(p)?correctNote():wrongNote();
            }
        };
    }
});

document.getElementById('clef').onchange=e=>{clef=e.target.checked?'bass':'treble';draw();}
document.getElementById('chord').onchange=e=>{chord=e.target.checked;start();}
document.getElementById('adaptive').onchange=e=>adaptive=e.target.checked;
document.getElementById('rhythm').onchange=e=>rhythm=e.target.checked;

start();
</script>
</body>
</html>
